LINK ZTAN_SHIP TO :$.PAR;
ERRMSG 1 WHERE :RETVAL <= 0 ;
LINK ZYUV_SHPMANIFEST TO :$.MSP ;
ERRMSG 1 WHERE :RETVAL <= 0 ;
DELETE FROM  ZYUV_PORTMNF ;
DELETE FROM ZYUV_GOVAGGOOD ;
DELETE FROM ZYUV_NOTIFYMNF ;
DELETE FROM ZTAN_TRANSCONDOC ;
:ZYUV_SHIP = 0  ;
:ZYUV_MANIFEST = '';
:ARRDATE =  01/01/88 ;
SELECT
SHIP,MITZARNUM,ARRIVEDATE INTO :ZYUV_SHIP,:ZYUV_MANIFEST,:ARRDATE
FROM ZTAN_SHIP
WHERE SHIP <> 0 ;
ERRMSG 9 WHERE :ZYUV_MANIFEST = '';
:PORTNAME = '' ;
SELECT
PORTS.PORTNAME
INTO :PORTNAME
FROM PORTS,ZTAN_SHIP
WHERE ZTAN_SHIP.PORT = PORTS.PORT
AND ZTAN_SHIP.SHIP = :ZYUV_SHIP ;
:PORTHP = '' ;
:PORTHP = (:PORTNAME = 'ILHFA' ? '513569749' :
'513569772') ;
/**/
INSERT INTO ZYUV_SHPMANIFEST
(SHIP,TRANSTIME,PORTHP,MNIFEST,ARRDATE)
VALUES (:ZYUV_SHIP,STRCAT(DTOA(SQL.DATE, 'YYYY-MM-DD'), 'T',
DTOA(SQL.DATE, 'hh:mm'), ':00'),:PORTHP,:ZYUV_MANIFEST,
STRCAT(DTOA(:ARRDATE, 'YYYY-MM-DD'), 'T',
'00:00', ':00')) ;
/**/
DECLARE ZYUV_VOL CURSOR FOR
SELECT
ORDERS.ORD
FROM ORDERS,ZTAN_ORDSHIP,ZTAN_SHIP
WHERE ORDERS.ORD = ZTAN_ORDSHIP.ORD
AND ZTAN_ORDSHIP.SHIP = ZTAN_SHIP.SHIP
AND ZTAN_SHIP.SHIP = :ZYUV_SHIP ;
OPEN ZYUV_VOL ;
GOTO 90 WHERE :RETVAL <= 0 ;
LABEL 10 ;
:ORD = 0 ;
FETCH ZYUV_VOL INTO :ORD ;
GOTO 80 WHERE :RETVAL <= 0 ;
/******* CHECK FOR NOTIFY**/
:ORDNAME = '';
SELECT ORDNAME INTO :ORDNAME FROM ORDERS WHERE ORD = :ORD ;
:PAR1 = :ORDNAME ;
ERRMSG 10 WHERE EXISTS(
SELECT
'X'
FROM ZTAN_SHIP ?,CUSTOMERS,ORDERS,ZTAN_ORDERS,ZTAN_ORDSHIP ?
WHERE ZTAN_ORDERS.ORD = ORDERS.ORD
AND ZTAN_ORDERS.NOTIFYCUST = CUSTOMERS.CUST
AND ZTAN_ORDSHIP.ORD = ORDERS.ORD
AND ZTAN_ORDSHIP.SHIP = ZTAN_SHIP.SHIP
AND ORDERS.ORD = :ORD
AND (CUSTOMERS.CUST = 0
OR CUSTOMERS.ADDRESS = '')) ;
/*******************/
:PAR1 = :ORDNAME  ;
ERRMSG 11 WHERE EXISTS(
SELECT
'X'
FROM ORDERS,CUSTOMERS
WHERE ORDERS.CUST = CUSTOMERS.CUST
AND ORDERS.ORD = :ORD
AND CUSTOMERS.ADDRESS = '') ;
/*******************/
:VOLUME = 0.0 ;
:PACKAGEQUANT = 0 ;
SELECT  COUNT(*)
INTO  :PACKAGEQUANT
FROM SPLITCOSTCENTERS
WHERE SPLITCOSTCENTERS.IV = :ORD
AND SPLITCOSTCENTERS.KLINE = -1
AND SPLITCOSTCENTERS.TYPE = 'O'
/*AND SPLITCOSTCENTERS.COSTC <>0*/ ;
/**/
:LINE = 0 ;
SELECT MAX(LINE) INTO :LINE
FROM ZTAN_ORDSHIP WHERE SHIP = :ZYUV_SHIP ;
:LINE = :LINE + 1;
UPDATE ZTAN_ORDSHIP SET
PACKAGEQUANT = :PACKAGEQUANT, LINE = :LINE
WHERE ORD = :ORD ;
/**/
:LINECODE = '';
SELECT
ZTAN_SAPANUT.LINECODE
INTO :LINECODE
FROM ZTAN_SAPANUT,ZTAN_SHIP
WHERE ZTAN_SHIP.SAPANUT = ZTAN_SAPANUT.SAPANUT
AND ZTAN_SHIP.SHIP = :ZYUV_SHIP ;
DELETE FROM ZYUV_ADDINFO ;
INSERT INTO ZYUV_ADDINFO
(ORD,TYPE,SKLINE,KLINE2,COSTC,LINECODE,ZTAN_TARA,REEFER)
SELECT
SPLITCOSTCENTERS.IV,
SPLITCOSTCENTERS.TYPE,
SPLITCOSTCENTERS.KLINE,
SPLITCOSTCENTERS.KLINE2,
COSTCENTERS.COSTC,
'KO',
'0',
(CONTAINERTYPES.ZYUV_REEFER  = 'Y' ? 1 : 0)
FROM ORDERS,ZTAN_SHIP,ZTAN_ORDSHIP,COSTCENTERS,SPLITCOSTCENTERS,
CONTAINERTYPES
WHERE ZTAN_ORDSHIP.ORD = ORDERS.ORD
AND ZTAN_SHIP.SHIP = ZTAN_ORDSHIP.SHIP
AND SPLITCOSTCENTERS.IV = ORDERS.ORD
AND SPLITCOSTCENTERS.COSTC = COSTCENTERS.COSTC
AND SPLITCOSTCENTERS.KLINE = - 1
AND SPLITCOSTCENTERS.TYPE ='O'
AND CONTAINERTYPES.CONTAINERTYPE = COSTCENTERS.ZYUV_CONTTYPE
AND  ZTAN_SHIP.SHIP = :ZYUV_SHIP ;
:CNAME = '';
SELECT
COUNTRIES.COUNTRYNAME
INTO :CNAME
FROM COUNTRIES,CUSTOMERS,ORDERS
WHERE ORDERS.ORD = :ORD
AND CUSTOMERS.CUST = ORDERS.ZTAN_HULSUP
AND COUNTRIES.COUNTRY = CUSTOMERS.COUNTRY ;
/**/
:DEFCNAME = '';
:DEFCNAME = 'ISRAEL' ;
:CNAME = (:CNAME <> '' ? :CNAME : :DEFCNAME) ;
INSERT INTO ZYUV_SHIPACCMNF(ORD,COUNTRYNAME)
VALUES (:ORD,:CNAME) ;
UPDATE ZYUV_SHIPACCMNF SET COUNTRYNAME = :CNAME
WHERE ORD = :ORD ;
/**/
INSERT INTO ZYUV_PORTMNF (ORD,PORT,TOPORT,LOADPORT,ARRDATE,
UNLOADPORT)
SELECT
ORDERS.ORD,
ORDERS.ZTAN_PORT,
ORDERS.ZTAN_TOPORT,
ORDERS.ZTAN_PORT,
STRCAT(DTOA(:ARRDATE, 'YYYY-MM-DD'), 'T',
'00:00', ':00'),
ZTAN_ORDERS.UNLOADPORT
FROM ORDERS,ZTAN_ORDERS
WHERE ORDERS.ORD = :ORD
AND ZTAN_ORDERS.ORD = ORDERS.ORD ;
INSERT INTO ZYUV_GOVAGGOOD (ORD,STATETYPE)
VALUES (:ORD,(:$.TYP = 10 ? '5' : '12'))  ;
/**/
INSERT INTO ZYUV_NOTIFYMNF (ORD,CUST)
SELECT
ORDERS.ORD,
CUSTOMERS.CUST
FROM ORDERS,CUSTOMERS,ZTAN_ORDERS
WHERE ZTAN_ORDERS.ORD = ORDERS.ORD
AND ZTAN_ORDERS.NOTIFYCUST = CUSTOMERS.CUST
AND ORDERS.ORD = :ORD ;
/**/
INSERT INTO ZTAN_TRANSCONDOC (ORD,KLINE,CONDITIONCODE,TYPECODE,
ID)
SELECT
ORDERS.ORD,
1,
'27',
'705',
ORDERS.ZTAN_LADINGNUM
FROM ORDERS
WHERE ORDERS.ORD = :ORD ;
/** CHECK FOR EXISTING DEALNUM FOR THE ORDERS **/
:ZYUV_EXDEALNUM = '';
SELECT
ORDERS.ZTAN_DEALNUM
INTO :ZYUV_EXDEALNUM
FROM ORDERS
WHERE ORD = :ORD ;
/*******/
:ZYUV_DEALNUM = 0;
SELECT
VALUE INTO :ZYUV_DEALNUM
FROM LASTS WHERE NAME = 'ZYUV_DEALNUM' ;
/**/
:ZYUV_MAXDEAL = 0;
SELECT
MAX(ZTAN_ORDSEND.SERIAL)
INTO :ZYUV_MAXDEAL
FROM ORDERS,ZTAN_SHIP ORIG,ZTAN_ORDSHIP,ZTAN_ORDSEND
WHERE ORDERS.ORD = ZTAN_ORDSHIP.ORD
AND ZTAN_ORDSHIP.SHIP = ORIG.SHIP
AND ZTAN_ORDSEND.ORD = ORDERS.ORD
AND ORIG.MITZARNUM = :ZYUV_MANIFEST  ;
/***/
:ZYUV_MAXDEAL = :ZYUV_MAXDEAL + 100 ;
/********/
:ZTAN_MANIFCODE = '' ;
SELECT
ZTAN_MANIFCODE INTO :ZTAN_MANIFCODE
FROM COMPDATA
WHERE COMPDATA.COMP = -1 ;
/********/
:ZYUV_FINALDEAL = '';
:ZYUV_FINALDEAL = STRCAT('I',:ZTAN_MANIFCODE,
(STRLEN(ITOA(:ZYUV_MAXDEAL))> 3  ? '00' :
'000'),ITOA(:ZYUV_MAXDEAL)) ;
/*******/
:ZYUV_EXDEALNUM = (:ZYUV_EXDEALNUM <> '' ?
:ZYUV_EXDEALNUM : :ZYUV_FINALDEAL)  ;
INSERT INTO ZTAN_TRANSCONDOC (ORD,KLINE,CONDITIONCODE,TYPECODE,
ID)
SELECT
ORDERS.ORD,
2,
'28',
'IL1',
:ZYUV_EXDEALNUM
FROM ORDERS
WHERE ORD = :ORD ;
/**/
UPDATE ORDERS SET ZTAN_DEALNUM =
:ZYUV_EXDEALNUM WHERE
ORD = :ORD ;
UPDATE LASTS SET VALUE = :ZYUV_DEALNUM + 100
WHERE NAME = 'ZYUV_DEALNUM' ;
/**** UPDATE ZTAN_ORDSEMD**/
:ZYUV_NUM = 0 ;
SELECT NUM INTO :ZYUV_NUM FROM ZTAN_ORDSEND WHERE ORD = :ORD
AND TYPE = 'M' ;
/***/
:ZYUV_SERIAL = 0 ;
SELECT SERIAL INTO :ZYUV_SERIAL FROM ZTAN_ORDSEND WHERE ORD = :ORD
AND TYPE = 'M' ;
:ZYUV_NUM = :ZYUV_NUM + 1;
INSERT INTO ZTAN_ORDSEND (ORD,TYPE,NUM,DEALNUM,SERIAL)
VALUES (:ORD,'M',:ZYUV_NUM,:ZYUV_EXDEALNUM,:ZYUV_MAXDEAL);
UPDATE ZTAN_ORDSEND SET NUM = :ZYUV_NUM,
DEALNUM = :ZYUV_EXDEALNUM,
SERIAL = (:ZYUV_SERIAL  <> 0 ? :ZYUV_SERIAL
: :ZYUV_MAXDEAL)
WHERE ORD = :ORD
AND TYPE = 'M' ;
LOOP 10 ;
LABEL 80 ;
CLOSE ZYUV_VOL ;
LABEL 90 ;
UPDATE LASTS SET VALUE = 100 WHERE NAME = 'ZYUV_DEALNUM' ;
DELETE FROM ZYUV_SHPMANIFEST ORIG ;
INSERT INTO ZYUV_SHPMANIFEST ORIG
SELECT * FROM ZYUV_SHPMANIFEST ;
/**/
:MEHES = '' ;
:MEHES = '941079089' ;
/**/
:HANI = '' ;
:HANI = 'IL513569780' ;
/**/
:COMPWTAXNUM = '';
SELECT
COMPDATA.WTAXNUM
INTO :COMPWTAXNUM
FROM COMPDATA
WHERE COMP = -1 ;
:FILENAME  = '';
:FILENAME  = STRCAT('../../SYSTEM/LOAD','/',
'SaveMN_MSG1170_1171_MANIFESTRequest_In.IL',:COMPWTAXNUM,
'.IL',:MEHES,'.',:HANI,'.',DTOA(SQL.DATE, 'YYYY-MM-DD_hh-mm-00'));
/*UPDATE ZTAN_ORDSHIP SET LINE = 0 ;*/
EXECUTE INTERFACE 'ZYUV_MANIGEN', SQL.TMPFILE, '-ou8', '-L',
:$.MSP, '-f', :FILENAME ;
/**/
EXECUTE FILTER '-replace',  '<MN_MSG1_MANIFEST>',
STRCAT(
'<MN_MSG1_MANIFEST xmlns:xsi="http://www.w3.org/2001/XMLSchema',
'-instance" xmlns:xsd="<uuii>'),
:FILENAME,
STRCAT('..\..\system\load\manifgen1', ITOA(SQL.USER)) ;
/**/
SLEEP 1 ;
/**/
EXECUTE FILTER '-replace',  '<uuii>',
STRCAT(
'http://www.w3.org/2001/XMLSchema" ',
'xmlns="http://malam.com/customs/CargoControl/MN_MSG1_MANIFEST">'),
STRCAT('..\..\system\load\manifgen1', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen2', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  '<TransmitionDateTime>',
STRCAT
('<TransmitionDateTime xmlns="http://ma',
'lam.com/customs/EAICommon.xsd">'),
STRCAT('..\..\system\load\manifgen2', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen3', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  '<SenderID>',STRCAT(
'<SenderID xmlns="http://ma',
'lam.com/customs/EAICommon.xsd">'),
STRCAT('..\..\system\load\manifgen3', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen4', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  '<RecieverID>',STRCAT(
'<RecieverID xmlns="http://ma',
'lam.com/customs/EAICommon.xsd">'),
STRCAT('..\..\system\load\manifgen4', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen5', ITOA(SQL.USER))  ;
EXECUTE FILTER '-replace',  '<Convertor>convertor</Convertor>',
STRCAT(
'<Convertor xsi:nil="true" ',
'xmlns="http://malam.com/customs/EAICommon.xsd" />'),
STRCAT('..\..\system\load\manifgen5', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen6', ITOA(SQL.USER));
SLEEP 1;
EXECUTE FILTER '-replace',  '<D1>',
'<Declaration xmlns="urn:wco:datamodel:WCO:CRI:1">',
STRCAT('..\..\system\load\manifgen6', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen7', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  '</D1>', '</Declaration>',
STRCAT('..\..\system\load\manifgen7', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen8', ITOA(SQL.USER));
/**/
SLEEP 1 ;
EXECUTE FILTER '-replace',  '<C1>', '<Consignment>',
STRCAT('..\..\system\load\manifgen8', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen9', ITOA(SQL.USER)) ;
/**/
SLEEP 1 ;
EXECUTE FILTER '-replace',  '</C1>', '</Consignment>',
STRCAT('..\..\system\load\manifgen9', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen10', ITOA(SQL.USER));
/**/
SLEEP 1;
EXECUTE FILTER '-replace',  '<C2>', '<ConsignmentItem>',
STRCAT('..\..\system\load\manifgen10', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen11', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  '</C2>', '</ConsignmentItem>',
STRCAT('..\..\system\load\manifgen11', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen12', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  '<C3>', '<CommodityRelatedPackaging>',
STRCAT('..\..\system\load\manifgen12', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen13', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  '</C3>',
'</CommodityRelatedPackaging>',
STRCAT('..\..\system\load\manifgen13', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen14', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  'bla1', 'AdditionalInformation',
STRCAT('..\..\system\load\manifgen14', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen15', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  'bla5', 'AdditionalInformation',
STRCAT('..\..\system\load\manifgen15', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen16', ITOA(SQL.USER)) ;
/**/
SLEEP 1;
EXECUTE FILTER '-replace',  'bla7', 'TransportContractDocument',
STRCAT('..\..\system\load\manifgen16', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifgen17', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  'Classification2',
'Classification',
STRCAT('..\..\system\load\manifgen17', ITOA(SQL.USER)),
:FILENAME ;
SLEEP 1 ;
/******************************/
:ENV = '' ;
SELECT SQL.ENV INTO :ENV FROM DUMMY;
:MILI = '' ;
:MILI = '-414.' ;
:FILENAME2 = STRCAT(:MILI, /*ITOA(:ZYUV_SHIP),*/
ITOA(:ORD), :ENV,
'.PRD.XML') ;
/**/
EXECUTE BACKGROUND CRE_CPT 1, :FILENAME, :FILENAME,
:FILENAME2 ;
UNLINK ZTAN_SHIP ;
UNLINK ZYUV_SHPMANIFEST  ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen1',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen2',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen3',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen4',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen5',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen6',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen7',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen8',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen9',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen10',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen11',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen12',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen13',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen14',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen15',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen16',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifgen17',
ITOA(SQL.USER)) ;
