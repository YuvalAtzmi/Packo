LINK ORDERS TO :$.PAR;
ERRMSG 1 WHERE :RETVAL <= 0 ;
LINK ZYUV_SHPMANIFEST TO :$.MSP ;
ERRMSG 1 WHERE :RETVAL <= 0 ;
DELETE FROM  ZYUV_PORTMNF ;
DELETE FROM ZYUV_GOVAGGOOD ;
DELETE FROM ZYUV_NOTIFYMNF ;
DELETE FROM ZTAN_TRANSCONDOC ;
DELETE FROM ZYUV_SMGORD;
/***********/
:ORD = 0 ;
SELECT ORD INTO :ORD FROM ORDERS WHERE ORD <>0 ;
INSERT INTO ZYUV_SMGORD (ORD) VALUES (:ORD) ;
/*****/
:ZYUV_SHIP = 0  ;
:ZYUV_MANIFEST = '';
:ARRDATE =  01/01/88 ;
/******/
SELECT
ZTAN_SHIP.SHIP,MITZARNUM,ARRIVEDATE
INTO :ZYUV_SHIP,:ZYUV_MANIFEST,:ARRDATE
FROM ORDERS,ZTAN_SHIP,ZTAN_ORDSHIP
WHERE ZTAN_SHIP.SHIP = ZTAN_ORDSHIP.SHIP
AND ZTAN_ORDSHIP.ORD = ORDERS.ORD
AND ORDERS.ORD = :ORD;
/***************/
/*:ZYUV_SHIP = 0  ;
:ZYUV_MANIFEST = '';
:ARRDATE =  01/01/88 ;
SELECT
SHIP,MITZARNUM,ARRIVEDATE INTO :ZYUV_SHIP,:ZYUV_MANIFEST,:ARRDATE
FROM ZTAN_SHIP
WHERE ZTAN_SHIP.SHIP <> 0 ;*/
ERRMSG 9 WHERE :ZYUV_MANIFEST = '';
:PORTNAME = '' ;
SELECT
PORTS.PORTNAME
INTO :PORTNAME
FROM PORTS,ZTAN_SHIP,ORDERS,ZTAN_ORDSHIP
WHERE ZTAN_SHIP.TOPORT = PORTS.PORT
AND ZTAN_SHIP.SHIP = ZTAN_ORDSHIP.SHIP
AND ZTAN_ORDSHIP.ORD = ORDERS.ORD
AND ORDERS.ORD = :ORD ;
SELECT :PORTNAME FROM DUMMY TABS 'C:\tmp\port.txt';
:PORTHP = '' ;
:PORTHP = (:PORTNAME = 'ILHFA' ? '513569749' :
'513569772') ;
/**/
INSERT INTO ZYUV_SHPMANIFEST
(SHIP,TRANSTIME,PORTHP,MNIFEST,ARRDATE)
VALUES (:ZYUV_SHIP,STRCAT(DTOA(SQL.DATE, 'YYYY-MM-DD'), 'T',
DTOA(SQL.DATE, 'hh:mm'), ':00'),:PORTHP,:ZYUV_MANIFEST,
STRCAT(DTOA(:ARRDATE, 'YYYY-MM-DD'), 'T',
'00:00', ':00')) ;
/**/
UPDATE ZTAN_ORDSHIP SET LINE = 0 ;
DECLARE ZYUV_VOL CURSOR FOR
SELECT
ORDERS.ORD
FROM ORDERS,ZTAN_ORDSHIP,ZTAN_SHIP
WHERE ORDERS.ORD = ZTAN_ORDSHIP.ORD
AND ZTAN_ORDSHIP.SHIP = ZTAN_SHIP.SHIP
AND ORDERS.ORDSTATUS <> -6
AND ORDERS.ORD = :ORD ;
OPEN ZYUV_VOL ;
GOTO 90 WHERE :RETVAL <= 0 ;
LABEL 10 ;
:ORD = 0 ;
FETCH ZYUV_VOL INTO :ORD ;
GOTO 80 WHERE :RETVAL <= 0 ;
/******* CHECK FOR NOTIFY**/
:ORDNAME = '';
SELECT ORDNAME INTO :ORDNAME FROM ORDERS WHERE ORD = :ORD ;
:PAR1 = :ORDNAME ;
ERRMSG 10 WHERE EXISTS(
SELECT
'X'
FROM ZTAN_SHIP ?,CUSTOMERS,ORDERS,ZTAN_ORDERS,ZTAN_ORDSHIP ?
WHERE ZTAN_ORDERS.ORD = ORDERS.ORD
AND ZTAN_ORDERS.NOTIFYCUST = CUSTOMERS.CUST
AND ZTAN_ORDSHIP.ORD = ORDERS.ORD
AND ZTAN_ORDSHIP.SHIP = ZTAN_SHIP.SHIP
AND ORDERS.ORD = :ORD
AND (CUSTOMERS.CUST = 0
OR CUSTOMERS.ADDRESS = '')) ;
/**********/
:PAR1 = :ORDNAME  ;
ERRMSG 11 WHERE EXISTS(
SELECT
'X'
FROM ORDERS,CUSTOMERS
WHERE ORDERS.CUST = CUSTOMERS.CUST
AND ORDERS.ORD = :ORD
AND CUSTOMERS.ADDRESS = '') ;
:VOLUME = 0.0 ;
:PACKAGEQUANT = 0 ;
SELECT SUM(SPLITCOSTCENTERS.ZTAN_VOLUME), COUNT(*)
INTO :VOLUME, :PACKAGEQUANT
FROM SPLITCOSTCENTERS
WHERE SPLITCOSTCENTERS.IV = :ORD
AND SPLITCOSTCENTERS.KLINE = -1
AND SPLITCOSTCENTERS.TYPE = 'O'
AND SPLITCOSTCENTERS.COSTC <>0 ;
/**/
:LINE = 0 ;
SELECT MAX(LINE) INTO :LINE
FROM ZTAN_ORDSHIP WHERE SHIP = :ZYUV_SHIP ;
:LINE = :LINE + 1;
UPDATE ZTAN_ORDSHIP SET VOLUME = :VOLUME,
PACKAGEQUANT = :PACKAGEQUANT, LINE = :LINE
WHERE ORD = :ORD ;
/**/
:LINECODE = '';
SELECT
ZTAN_SAPANUT.LINECODE
INTO :LINECODE
FROM ZTAN_SAPANUT,ZTAN_SHIP,ORDERS,ZTAN_ORDSHIP
WHERE ZTAN_SHIP.SAPANUT = ZTAN_SAPANUT.SAPANUT
AND ZTAN_SHIP.SHIP = ZTAN_SHIP.SHIP
AND ZTAN_ORDSHIP.ORD = ORDERS.ORD
AND ORDERS.ORD = :ORD;
/*AND ZTAN_SHIP.SHIP = :ZYUV_SHIP ;*/
DELETE FROM ZYUV_ADDINFO ;
INSERT INTO ZYUV_ADDINFO
(ORD,TYPE,SKLINE,KLINE2,COSTC,LINECODE,ZTAN_TARA,REEFER)
SELECT
SPLITCOSTCENTERS.IV,
SPLITCOSTCENTERS.TYPE,
SPLITCOSTCENTERS.KLINE,
SPLITCOSTCENTERS.KLINE2,
COSTCENTERS.COSTC,
:LINECODE,
SPLITCOSTCENTERS.ZTAN_TARA,
(CONTAINERTYPES.ZYUV_REEFER  = 'Y' ? 1 : 0)
FROM ORDERS,ZTAN_SHIP,ZTAN_ORDSHIP,COSTCENTERS,SPLITCOSTCENTERS,
CONTAINERTYPES
WHERE ZTAN_ORDSHIP.ORD = ORDERS.ORD
AND ZTAN_SHIP.SHIP = ZTAN_ORDSHIP.SHIP
AND SPLITCOSTCENTERS.IV = ORDERS.ORD
AND SPLITCOSTCENTERS.COSTC = COSTCENTERS.COSTC
AND SPLITCOSTCENTERS.KLINE = - 1
AND SPLITCOSTCENTERS.TYPE ='O'
AND CONTAINERTYPES.CONTAINERTYPE = COSTCENTERS.ZYUV_CONTTYPE
/*AND  ZTAN_SHIP.SHIP = :ZYUV_SHIP ;*/
AND ORDERS.ORD = :ORD;
/******************/
:CNAME = '';
SELECT
COUNTRIES.COUNTRYNAME
INTO :CNAME
FROM COUNTRIES,CUSTOMERS,ORDERS
WHERE ORDERS.ORD = :ORD
AND CUSTOMERS.CUST = ORDERS.ZTAN_HULSUP
AND COUNTRIES.COUNTRY = CUSTOMERS.COUNTRY ;
/**/
:CNAME = (:CNAME <> '' ? :CNAME : 'ISRAEL') ;
INSERT INTO ZYUV_SHIPACCMNF(ORD,COUNTRYNAME)
VALUES (:ORD,:CNAME) ;
UPDATE ZYUV_SHIPACCMNF SET COUNTRYNAME = :CNAME
WHERE ORD = :ORD ;
/**/
INSERT INTO ZYUV_PORTMNF (ORD,PORT,TOPORT,LOADPORT,ARRDATE,
UNLOADPORT)
SELECT
ORDERS.ORD,
ORDERS.ZTAN_PORT,
ORDERS.ZTAN_TOPORT,
ORDERS.ZTAN_PORT,
STRCAT(DTOA(:ARRDATE, 'YYYY-MM-DD'), 'T',
'00:00', ':00'),
ORDERS.ZTAN_TOPORT
FROM ORDERS
WHERE ORD = :ORD ;
INSERT INTO ZYUV_GOVAGGOOD (ORD,STATETYPE)
VALUES (:ORD,(:$.TYP = 10 ? '5' : '12'))  ;
/**/
INSERT INTO ZYUV_NOTIFYMNF (ORD,CUST)
SELECT
ORDERS.ORD,
CUSTOMERS.CUST
FROM ORDERS,CUSTOMERS,ZTAN_ORDERS
WHERE ZTAN_ORDERS.ORD = ORDERS.ORD
AND ZTAN_ORDERS.NOTIFYCUST = CUSTOMERS.CUST
AND ORDERS.ORD = :ORD ;
/**/
INSERT INTO ZTAN_TRANSCONDOC (ORD,KLINE,CONDITIONCODE,TYPECODE,
ID)
SELECT
ORDERS.ORD,
1,
'27',
'704',
ORDERS.ZTAN_LADINGNUM
FROM ORDERS
WHERE ORDERS.ORD = :ORD ;
/**/
:ZYUV_FINALDEAL = '';
SELECT ORDERS.ZTAN_DEALNUM INTO :ZYUV_FINALDEAL
FROM ORDERS WHERE ORDERS.ORD = :ORD ;
/********/
INSERT INTO ZTAN_TRANSCONDOC (ORD,KLINE,CONDITIONCODE,TYPECODE,
ID)
SELECT
ORDERS.ORD,
2,
'27',
'IL1',
:ZYUV_FINALDEAL
FROM ORDERS
WHERE ORD = :ORD ;
UPDATE ORDERS SET ZTAN_DEALNUM =
:ZYUV_FINALDEAL
WHERE ORD = :ORD ;
/**/
/*UPDATE LASTS SET VALUE = :ZYUV_DEALNUM + 100
WHERE NAME = 'ZYUV_DEALNUM' ;*/
LOOP 10 ;
LABEL 80 ;
CLOSE ZYUV_VOL ;
LABEL 90 ;
UPDATE LASTS SET VALUE = 100 WHERE NAME = 'ZYUV_DEALNUM' ;
DELETE FROM ZYUV_SHPMANIFEST ORIG ;
INSERT INTO ZYUV_SHPMANIFEST ORIG
SELECT * FROM ZYUV_SHPMANIFEST ;
/**/
:MEHES = '' ;
:MEHES = '941079089' ;
/**/
:HANI = '' ;
:HANI = '513569780' ;
/**/
:COMPWTAXNUM = '';
SELECT
COMPDATA.WTAXNUM
INTO :COMPWTAXNUM
FROM COMPDATA
WHERE COMP = -1 ;
:FILENAME  = '';
:FILENAME  = STRCAT('..\..\system\load','/',
'SaveMN_MSG1170_1171_MANIFESTRequest_In.IL',:COMPWTAXNUM,
'.IL',:MEHES,'.','IL',:HANI,'.')  ;
/**/
EXECUTE INTERFACE 'ZYUV_MANIFESTSHPNEW', SQL.TMPFILE, '-ou8', '-L',
:$.MSP, '-f', :FILENAME ;
/**/
/**/
EXECUTE FILTER '-replace',  '<A>', '<MN_MSG1_MANIFEST>',
:FILENAME, STRCAT('..\..\system\load\manifshp1', ITOA(SQL.USER)) ;
/**/
SLEEP 1 ;
/**/
EXECUTE FILTER '-replace',  '</A>', '</MN_MSG1_MANIFEST>',
STRCAT('..\..\system\load\manifshp1', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp2', ITOA(SQL.USER)) ;
/**/
SLEEP 1 ;
/**/
EXECUTE FILTER '-replace',  '<MN_MSG1_MANIFEST>',
STRCAT(
'<MN_MSG1_MANIFEST xmlns:xsi="http://www.w3.org/2001/XMLSchema',
'-instance" xmlns:xsd="<uuii>'),
STRCAT('..\..\system\load\manifshp2', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp3', ITOA(SQL.USER)) ;
/**/
SLEEP 1 ;
/**/
EXECUTE FILTER '-replace',  '<uuii>',
STRCAT(
'http://www.w3.org/2001/XMLSchema" ',
'xmlns="http://malam.com/customs/CargoControl/MN_MSG1_MANIFEST">'),
STRCAT('..\..\system\load\manifshp3', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp4', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  '<TransmitionDateTime>',
STRCAT
('<TransmitionDateTime xmlns="http://ma',
'lam.com/customs/EAICommon.xsd">'),
STRCAT('..\..\system\load\manifshp4', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp5', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace',  '<SenderID>',
'<SenderID xmlns="http://malam.com/customs/EAICommon.xsd">',
STRCAT('..\..\system\load\manifshp5', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp6', ITOA(SQL.USER)) ;
SLEEP 1;
EXECUTE FILTER '-replace','xsi:nil="true"',STRCAT(
'xsi:nil="true" ',
'xmlns="http://malam.com/customs/EAICommon.xsd"/'),
STRCAT('..\..\system\load\manifshp6', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp7', ITOA(SQL.USER)) ;
/**/
EXECUTE FILTER '-replace','</Convertor>','',
STRCAT('..\..\system\load\manifshp7', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp8', ITOA(SQL.USER)) ;
/**/
SLEEP 1;
EXECUTE FILTER '-replace',  '<D1>',
'<Declaration xmlns="urn:wco:datamodel:WCO:CRI:1">',
STRCAT('..\..\system\load\manifshp8', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp9', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  '</D1>', '</Declaration>',
STRCAT('..\..\system\load\manifshp9', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp10', ITOA(SQL.USER));
/**/
SLEEP 1 ;
EXECUTE FILTER '-replace',  '<C1>', '<Consignment>',
STRCAT('..\..\system\load\manifshp10', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp11', ITOA(SQL.USER)) ;
/**/
SLEEP 1 ;
EXECUTE FILTER '-replace',  '</C1>', '</Consignment>',
STRCAT('..\..\system\load\manifshp11', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp12', ITOA(SQL.USER));
/**/
SLEEP 1;
EXECUTE FILTER '-replace',  '<C2>', '<ConsignmentItem>',
STRCAT('..\..\system\load\manifshp12', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp13', ITOA(SQL.USER));
/**/
SLEEP 1;
EXECUTE FILTER '-replace',  'bla2', 'AdditionalInformation',
STRCAT('..\..\system\load\manifshp13', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp14', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  'bla3', 'AdditionalInformation',
STRCAT('..\..\system\load\manifshp14', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp15', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  'bla4', 'AdditionalInformation',
STRCAT('..\..\system\load\manifshp15', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp16', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  'bla5', 'AdditionalInformation',
STRCAT('..\..\system\load\manifshp16', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp17', ITOA(SQL.USER)) ;
SLEEP 1 ;
/**/
EXECUTE FILTER '-replace',  'bla6', 'AdditionalInformation',
STRCAT('..\..\system\load\manifshp17', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp18', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  'bla7', 'TransportContractDocument',
STRCAT('..\..\system\load\manifshp18', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp19', ITOA(SQL.USER)) ;
/**/
EXECUTE FILTER '-replace',  '<C3>', '<GovernmentAgencyGoodsItem>',
STRCAT('..\..\system\load\manifshp19', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp20', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  '</C3>',
'</GovernmentAgencyGoodsItem>',
STRCAT('..\..\system\load\manifshp20', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp21', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  'Classification2',
'Classification',
STRCAT('..\..\system\load\manifshp21', ITOA(SQL.USER)),
STRCAT('..\..\system\load\manifshp22', ITOA(SQL.USER)) ;
SLEEP 1 ;
EXECUTE FILTER '-replace',  '</C2>', '</ConsignmentItem>',
STRCAT('..\..\system\load\manifshp22', ITOA(SQL.USER)),
:FILENAME;
:TRANSLOG = 0 ;
SELECT
MAX(TRANSLOGLINE)
INTO :TRANSLOG
FROM ZARI_SHIPLOG
WHERE ZARI_SHIPLOG.SHIP = :ZYUV_SHIP ;
:TRANSLOG = :TRANSLOG + 1;
:MILI = '' ;
:MILI = '-414.' ;
:ENV = '';
SELECT SQL.ENV INTO :ENV FROM DUMMY;
:FILENAME2 = STRCAT('IL',:PORTHP,'.',
DTOA(SQL.DATE, 'YYYY-MM-DD_hh-mm-00'),:MILI,
/*STRCAT(ITOA(:ZYUV_SHIP),ITOA(:TRANSLOG)),*/
STRCAT(ITOA(:ORD),:ENV),
'.PRD.XML') ;
/**/
EXECUTE BACKGROUND CRE_CPT 1, :FILENAME, :FILENAME,
:FILENAME2 ;
/**/
:KLINE = 0 ;
SELECT KLINE INTO :KLINE FROM ZARI_SHIPLOG WHERE SHIP = :ZYUV_SHIP ;
/**/
:KLINE = :KLINE + 1;
:DES = 'מסר מצהר' ;
:TYPE = 'חדש' ;
:STATUS = 'שודר' ;
INSERT INTO ZARI_SHIPLOG (SHIP,KLINE,UDATE,USER,NAME,DES,TYPE,
STATUS,TRANSLOGLINE)
VALUES (:ZYUV_SHIP,:KLINE,SQL.DATE,SQL.USER,'MANIFEST',:DES,:TYPE,
:STATUS,:TRANSLOG)  ;
UNLINK ZYUV_SHPMANIFEST ;
UNLINK ZTAN_SHIP ;
WRNMSG 8;
/*
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp1',
ITOA(SQL.USER)) ;
*/
/**/
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp2',
ITOA(SQL.USER)) ;
/**/
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp3',
ITOA(SQL.USER)) ;
/**/
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp4',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp5',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp6',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp7',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp8',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp9',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp10',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp11',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp12',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp13',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp14',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp15',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp16',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp17',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp18',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp19',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp20',
ITOA(SQL.USER)) ;
EXECUTE DELWINDOW 'f', STRCAT('..\..\system\load\manifshp21',
ITOA(SQL.USER)) ;
